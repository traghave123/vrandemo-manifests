apiVersion: apps/v1
kind: Deployment
metadata:
  name: 5g-du-01-seattle-p1
  namespace: xnf-5g-du-seattle
  labels:
    node-role.kubernetes.io/ran-du-seattle-server-profile-du-supermicro00: ""
spec:
   selector:
     matchLabels:
       node-role.kubernetes.io/ran-du-seattle-server-profile-du-supermicro00: ""
   serviceName: 4glte-du-seattle-p1
   replicas: 1
   strategy:
     type: Recreate
   template:
    metadata:
      labels:
        node-role.kubernetes.io/ran-du-seattle-server-profile-du-supermicro00: ""
      annotations:
        cpu-load-balancing.crio.io: "true"
        k8s.v1.cni.cncf.io/networks: |-
          [
            {
              "name": "seattle-vran-mgmt",
              "ips": ["172.31.10.11/24"]
            },
            {
              "name": "seattle-vran-mh",
              "ips": ["172.31.11.11/24"]
            },
            {
              "name": "seattle-vran-mp",
              "ips": ["172.21.0.210/16"]
            },
            {
              "name": "seattle-vran-fh"
            }]
    spec:
      terminationGracePeriodSeconds: 20
      serviceAccountName: dp-sa-r
      serviceAccount: dp-sa-r
      runtimeClassName: performance-ran-du-seattle-server-profile-du-supermicro00-pao-profile-du-supermicro00
      nodeSelector:
        node-role.kubernetes.io/ran-du-seattle-server-profile-du-supermicro00: ""
      containers:
        - name: ani-4g-du1
          image: "ran-21-kvm.comm.ibm.gsc:5000/olmlocal/hello-openshift:latest"
          imagePullPolicy: IfNotPresent       
          #command: ["bash","-c","/opt/ani/helm/entrypoint.sh","while true; do sleep 1000; done"]
          envFrom:
            - configMapRef:
                name: 4glte-du-seattle-cm
          env:
             - name: NODE_NAME
               valueFrom:
                 fieldRef:
                   fieldPath: spec.nodeName
             - name: MY_POD_IP
               valueFrom:
                 fieldRef:
                   fieldPath: status.podIP
          volumeMounts:
            - mountPath: /mnt/huge
              name: hugepage
              readOnly: false
            - name: devices
              mountPath: /sys/devices
              readOnly: false
            - mountPath: /memfs
              name: memfs
            - mountPath: /dskfs/fm
              name: dskfsfm
            - mountPath: /opt/ani/helm/
              name: scripts
            - mountPath: /prov-config/
              name: prov
   
          resources:
            requests:
              ephemeral-storage: 10Gi
              hugepages-1Gi: 10Gi
              memory: 10Gi
              openshift.io/vran_netdevice_mgmt_mh: 2
              openshift.io/vran_netdevice_mp: 1
              openshift.io/vran_vfio_fh: 1
              #intel.com/intel_fec_lte: 1
              cpu: "18"
            limits:
              ephemeral-storage: 10Gi
              hugepages-1Gi: 10Gi
              memory: 10Gi
              openshift.io/vran_netdevice_mgmt_mh: 2
              openshift.io/vran_netdevice_mp: 1
              openshift.io/vran_vfio_fh: 1
              #intel.com/intel_fec_lte: 1
              cpu: "18"
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
                - SYS_MODULE
                - SYS_NICE
                - SYS_RESOURCE
                - IPC_LOCK
                - FOWNER
      volumes:
        - name: hugepage
          emptyDir:
            medium: HugePages
        - name: devices
          hostPath:
            path: "/sys/devices"
        - name: memfs
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi
        - name: dskfsfm
          hostPath:
            path: "/var/newdskfs/1"
        - name: prov
          configMap:
            name: 4glte-du-01-seattle-p1
            items:
            - key: prov.ini
              path: prov.ini
        - name: scripts
          configMap:
            name: ani-scripts
            items:
            - key: entrypoint
              path: entrypoint.sh
            - key: cpuLayout
              path: ani_cpu_layout.sh
            defaultMode: 0777
      tolerations:
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
        - key: "node.kubernetes.io/not-ready"
          operator: "Exists"
          effect: "NoExecute"
        - key: "node.kubernetes.io/unschedulable"
          operator: "Exists"
          effect: "NoExecute"
